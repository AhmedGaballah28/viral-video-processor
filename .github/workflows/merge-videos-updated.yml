name: Merge Videos FREE

on:
  repository_dispatch:
    types: [merge-videos]
  workflow_dispatch:
    inputs:
      video_urls:
        description: 'JSON array of 4 video URLs'
        required: true
        type: string
        default: '["https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4","https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4","https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4","https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4"]'
      hook_text:
        description: 'Hook text overlay'
        required: true
        type: string
        default: 'AMAZING TEST'
      title_text:
        description: 'Title text overlay'
        required: true
        type: string
        default: 'Test Video Title'

jobs:
  merge:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg fonts-dejavu-core
        pip install requests
        ffmpeg -version
    
    - name: Process Videos
      id: process
      env:
        VIDEO_URLS: ${{ github.event.client_payload.video_urls || inputs.video_urls }}
        HOOK_TEXT: ${{ github.event.client_payload.hook_text || inputs.hook_text }}
        TITLE_TEXT: ${{ github.event.client_payload.title_text || inputs.title_text }}
      run: |
        python merge-videos.py
        echo "video_created=true" >> $GITHUB_OUTPUT
        ls -la final.mp4
    
    - name: Upload to File.io (FREE hosting)
      id: upload
      run: |
        # Upload to file.io (FREE, 14 days retention, no size limit)
        response=$(curl -F "file=@final.mp4" https://file.io)
        echo "Response: $response"
        VIDEO_URL=$(echo $response | grep -o '"link":"[^"]*' | sed 's/"link":"//')
        echo "VIDEO_URL=$VIDEO_URL" >> $GITHUB_OUTPUT
        echo "Video uploaded to: $VIDEO_URL"
        echo "$VIDEO_URL" > video_url.txt
    
    - name: Save Video as Artifact
      uses: actions/upload-artifact@v3
      with:
        name: final-video
        path: |
          final.mp4
          video_url.txt
        retention-days: 7
    
    - name: Create Summary
      run: |
        echo "## âœ… Video Processed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Download URL:" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.upload.outputs.VIDEO_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Valid for:** 14 days" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Video Details:" >> $GITHUB_STEP_SUMMARY
        echo "- **Hook:** ${{ github.event.client_payload.hook_text || inputs.hook_text }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Title:** ${{ github.event.client_payload.title_text || inputs.title_text }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Processing Time:** ~90 seconds" >> $GITHUB_STEP_SUMMARY